<!DOCTYPE HTML>
<html>

<head>

    <title>Host a Quiz</title>
    <link rel="stylesheet" href="fonts.css">
    <link rel="stylesheet" href="styles.css">

</head>

<body>

    <div class="mainContainer">

        <h1 class="mainContainerHeader">Hosting a quiz</h1>
        <h2 class="mainContainerSubheader">Starting peer-to-peer connection...</h2>

        <p class="connectionInstructions"></p><a class="copyLinkButton" style="display: none;" onclick="copyLinkToClipboard()">Copy Link</a>

        <p class="connectedQuizzersTitle">Connected Quizzers:</p>
        <ul class="connectedQuizzersList"></ul>

        <div class="statusBox"></div>

    </div>
    <div class="controlBox">

        <button class="armButton" onclick="arm()">Arm</button>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.2.0/dist/peerjs.min.js"></script>
    <script>
        var mainContainerHeader = document.querySelector(".mainContainerHeader");
        var mainContainerSubheader = document.querySelector(".mainContainerSubheader");
        var connectionInstructions = document.querySelector(".connectionInstructions");
        var copyLinkButton = document.querySelector(".copyLinkButton");
        var connectedQuizzersList = document.querySelector(".connectedQuizzersList");
        var armButton = document.querySelector(".armButton");
        var statusBox = document.querySelector(".statusBox");

        var currentPeerLink;
        var listeningForJump = false;

        var peer;
        var lastPeerId;
        var conn = {};

        function initialize() {
            // Create own peer object with connection to shared PeerJS server
            peer = new Peer(null, {
                debug: 0
            });

            peer.on('open', function(id) {
                // Workaround for peer.reconnect deleting previous id
                if (peer.id === null) {
                    console.log('Received null id from peer open');
                    peer.id = lastPeerId;
                } else {
                    lastPeerId = peer.id;
                }

                console.log("ID: " + peer.id);
                console.log("Awaiting connection.")

                mainContainerSubheader.textContent = "Ready for connections."
                connectionInstructions.innerHTML = "To join the quiz, go to cadehunter.github.io/Virtual-Quiz/join.html?" + peer.id;
                copyLinkButton.style.display = "";
                currentPeerLink = "cadehunter.github.io/Virtual-Quiz/join.html?" + peer.id;

            });
            peer.on('connection', function(c) {

                conn[c.peer] = c;
                console.log("Connected to: " + c.peer);
                ready(c.peer);

            });
            peer.on('disconnected', function() {
                console.log('Connection lost. Please reconnect');

                // Workaround for peer.reconnect deleting previous id
                peer.id = lastPeerId;
                peer._lastServerId = lastPeerId;
                peer.reconnect();
            });
            peer.on('close', function() {
                conn = null;
                console.log('Connection destroyed');
            });
            peer.on('error', function(err) {
                console.log(err);
            });
        };

        function ready(peerID) {
            (function() {
                conn[peerID].on('data', function(data) {
                    console.log("Data recieved");
                    console.log("Received " + data + " from " + peerID);
                    receivedData(data, peerID);
                });
                conn[peerID].on('close', function() {
                    console.log("Connection to " + peerID + " reset. Awaiting connection...");
                    if (conn[peerID].firstName) {
                        var elements = document.querySelectorAll("." + peerID + "ListItem");
                        for (var i = 0; i < elements.length; i++) {
                            connectedQuizzersList.removeChild(elements[i]);
                        }
                    }
                    conn[peerID] = null;
                });
            })()
        }

        function sendMessage(peerID, message) {
            if (conn[peerID] && conn[peerID].open) {
                conn[peerID].send(message);
                console.log("Sent: " + message + " to " + peerID);
            } else {
                console.log('Connection is closed');
            }
        }

        initialize();

        function receivedData(data, peerID) {

            var splitData = data.split(";");
            var type = splitData[0];

            switch (type) {

                case "jump":

                    if (listeningForJump) {

                        listeningForJump = false;
                        statusBox.textContent = conn[peerID][splitData[1]].firstName + " " + conn[peerID][splitData[1]].lastName + " jumped.";
                        armButton.textContent = "Arm";
                        //forwardJumpEvent(peerID);

                    }

                    break;
                case "setup":

                    conn[peerID].quizzer3 = {};
                    conn[peerID].quizzer2 = {};
                    conn[peerID].quizzer1 = {};

                    var numberOfQuizzers = splitData[1];
                    switch (numberOfQuizzers) {
                        case "3":
                            conn[peerID].quizzer3.firstName = splitData[6];
                            conn[peerID].quizzer3.lastName = splitData[7];
                        case "2":
                            conn[peerID].quizzer2.firstName = splitData[4];
                            conn[peerID].quizzer2.lastName = splitData[5];
                        case "1":
                            conn[peerID].quizzer1.firstName = splitData[2];
                            conn[peerID].quizzer1.lastName = splitData[3];
                            break;
                    }

                    for (var i = 0; i < numberOfQuizzers; i++) {

                        (function() {
                            var element = document.createElement("li");
                            element.textContent = conn[peerID]["quizzer" + (i + 1)].firstName + " " + conn[peerID]["quizzer" + (i + 1)].lastName;
                            element.classList.add(peerID + "ListItem");
                            connectedQuizzersList.appendChild(element);
                        })()

                    }

                    break;

            }

        }

        function copyLinkToClipboard() {
            var element = document.createElement('textarea');
            element.value = currentPeerLink;
            element.setAttribute('readonly', '');
            element.style.position = 'absolute';
            element.style.left = '-9999px';
            document.body.appendChild(element);
            element.select();
            document.execCommand('copy');
            document.body.removeChild(element);
            copyLinkButton.textContent = "Link Copied";
            setTimeout(function() {
                copyLinkButton.textContent = "Copy Link"
            }, 5000);
        }

        function arm() {

            listeningForJump = true;
            statusBox.textContent = "";
            armButton.textContent = "Armed";

        }

        function forwardJumpEvent(peerID) {

            var keys = Object.keys(conn);
            for (var i = 0; i < keys.length; i++) {
                sendMessage(keys[i], "jumped;" + conn[peerID].firstName + ";" + conn[peerID].lastName);
            }

        }

    </script>

</body>

</html>
