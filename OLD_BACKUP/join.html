<!DOCTYPE HTML>
<html>

<head>

    <title>Join a Quiz</title>
    <link rel="stylesheet" href="fonts.css">
    <link rel="stylesheet" href="styles.css">

</head>

<body>

    <div class="mainScreen" style="display: none">

        <div class="mainContainer">

            <h1 class="mainContainerHeader">Connected to Quiz</h1>
            <h2 class="mainContainerSubheader">You are now an active quizzer in this quiz.</h2>

            <div class="statusBox"></div>

        </div>
        <div class="controlBox">

            <button class="jumpButton" onclick="jump()">Jump</button>

        </div>

    </div>
    <div class="connectScreen">

        <h1 class="mainContainerHeader">Joining a quiz</h1>
        <h2 class="mainContainerSubheader connectScreenSubheader">We're connecting you to your quiz round...</h2>

        <div class="connectScreenInputArea">
            <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: fit-content;">
                <input type="text" class="firstNameInput" placeholder="First Name">
                <input type="text" class="lastNameInput" placeholder="Last Name">
                <button class="connectScreenJoinButton" onclick="joinButtonClicked()">Join Round</button>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.2.0/dist/peerjs.min.js"></script>
    <script>
        var mainContainerHeader = document.querySelector(".mainContainerHeader");
        var mainContainerSubheader = document.querySelector(".mainContainerSubheader");
        var jumpButton = document.querySelector(".jumpButton");

        var connectScreenSubheader = document.querySelector(".connectScreenSubheader");
        var firstNameInput = document.querySelector(".firstNameInput");
        var lastNameInput = document.querySelector(".lastNameInput");

        var mainScreen = document.querySelector(".mainScreen");
        var connectScreen = document.querySelector(".connectScreen");

        var firstName;
        var lastName;

        var peer;
        var lastPeerId;
        var conn;
        //Get the ID specified in the address after the "?" sign
        var idToConnectTo = window.location.href.split("?")[1];

        function initialize() {
            // Create own peer object with connection to shared PeerJS server
            peer = new Peer(null, {
                debug: 0
            });

            peer.on('open', function(id) {
                // Workaround for peer.reconnect deleting previous id
                if (peer.id === null) {
                    console.log('Received null id from peer open');
                    peer.id = lastPeerId;
                } else {
                    lastPeerId = peer.id;
                }

                console.log('ID: ' + peer.id);
                join();
            });
            peer.on('disconnected', function() {
                console.log('Connection lost. Please reconnect');

                // Workaround for peer.reconnect deleting previous id
                peer.id = lastPeerId;
                peer._lastServerId = lastPeerId;
                peer.reconnect();
            });
            peer.on('close', function() {
                conn = null;
                console.log('Connection destroyed');
            });
            peer.on('error', function(err) {
                console.log(err);
                connectScreenSubheader.textContent = "Something went wrong. Try again in a few minutes."
                mainContainerHeader.textContent = "Something went wrong"
                mainContainerSubheader.textContent = "Try again in a few minutes."
            });
        };

        function join() {
            // Close old connection
            if (conn) {
                conn.close();
            }

            // Create connection to destination peer specified in the input field
            conn = peer.connect(idToConnectTo, {
                reliable: true
            });

            conn.on('open', function() {
                connectScreenSubheader.textContent = "Connected to quiz.";
                console.log("Connected to: " + conn.peer);
            });

            // Handle incoming data
            conn.on('data', function(data) {
                console.log("Received: " + data);
                receivedData(data)
            });
            conn.on('close', function() {
                console.log("Connection closed");
                mainContainerHeader.textContent = "Connection closed";
                mainContainerSubheader.textContent = "The connection was closed by the quizmaster.";
            });
        };

        function receivedData(data) {

            var splitData = data.split(";");
            var type = splitData[0];

            switch (type) {

                case "jumped":

                    if (splitData[1] == firstName) {
                        statusBox.textContent = "You jumped.";
                    } else {
                        statusBox.textContent = splitData[1] + " " + splitData[2] + " jumped.";
                    }

                    break;

            }

        }

        function sendMessage(message) {
            if (conn && conn.open) {
                conn.send(message);
                console.log("Sent: " + message);
            } else {
                console.log('Connection is closed');
            }
        }

        function jump() {

            sendMessage("jump;jump");

        }

        function joinButtonClicked() {

            firstName = firstNameInput.value;
            lastName = lastNameInput.value;
            sendMessage("setup;" + firstName + ";" + lastName);

            connectScreen.style.display = "none";
            mainScreen.style.display = "";

        }

        initialize();

    </script>

</body>

</html>
